# Smart Umbrella Stand
라즈베리 파이 4와 카메라를 이용한 안면 인식, 센서와 led를 활용하여 사용자별 우산 위치 표시, 날씨 정보 제공 및 내부 습도 자동 조절 기능을 갖춘 지능형 우산 보관함 프로젝트

1. 프로젝트 개요

    목적: 안면 인식을 통한 사용자별 우산 위치와 당일 강수 확률을 LED로 표시하고, 우산 보관 시 습도를 측정하여 자동 건조

    기능: 
  
    - OpenCV(LBPH)를 이용한 온보드 안면 인식을 통해 사용자를 식별하고 배정된 자리를 LED로 표시
  
    - Open-Meteo API를 연동하여 향후 12시간 내 강수 확률을 RGB LED 색상으로 표시
  
    - 우산 보관시 DHT22 센서로 내부 습도를 감지하여 기준치 초과 시 쿨링팬 자동 구동
  
    - 초음파 센서를 이용한 사용자 접근 감지 및 우산 보관 상태 실시간 업데이트
  
<br>

2. 기술 스택
  
   Board: Raspberry Pi 4 Model B

   API & Libraries:
   
  -OpenCV: 안면 인식 알고리즘(LBPH) 및 카메라 제어
   
  -RPi.GPIO: 센서 및 액추에이터 제어
  
  -Adafruit_DHT: 습도 데이터 수집
  
  -Open-Meteo API: 실시간 기상 데이터(PoP) 수신

   Peripherals:

   -HC-SR04: 사용자 접근 및 우산 유무 감지

   -DHT22: 내부 습도 측정

   -RGB LED & Single LED: 날씨 및 사용자별 보관 위치 시각화

   -Cooling Fan: 제습을 통한 습도 조 

<br>
    
3. 시스템 구조

   i. 모듈형 소프트웨어 구조
   
   -main.py: 상태 머신 기반의 중앙 제어 로직 수행
   
   -hardware_manager.py: GPIO 핀 초기화, 센서 측정, 팬과 LED 제어 추상화
   
   -umbrella_storage.py: 우산 보관함 상태 관리 및 사용자와 자리 간 매핑
   
   -faceRec.py: 카메라 구동 및 LBPH 기반 온보드 안면 인식

   -pop.py: 외부 날씨 API 연동 및 데이터 가공

   <br>

   ii. 상태 머신
   
   -STATE_IDLE: 초음파 센서로 사용자 접근 감지

   -STATE_PERSON_DETECTED: 사용자 감지 시 날씨 정보 업데이트 및 안면 인식 활성화

   -STATE_USER_RECOGNIZED: 특정 사용자 식별 시 해당 보관 칸 LED 점등

   -STATE_UMBRELLA_ACTIVITY: 우산 반입, 반출 감지 및 습도에 따른 팬 구동 처리

   <br>
   
5. 핵심 로직

  1. 사용자 감지: 사용자 감지 초음파 센서가 10cm 이내 물체 감지 시 시스템 활성화
  
  2. 안면 인식: 카메라를 통해 등록된 사용자(User A, B) 확인 및 지정된 우산 위치 LED 점등
  
  3. 강수 확률 표시: API 호출 결과에 따라 RGB LED 표시
  
  4.우산 감지: 보관 칸 내부 초음파 센서(US1, US2)로 우산 유무 실시간 모니터링
  
  5.자동 제습: 우산 반입 시 습도가 20%를 초과할 경우 쿨링팬을 10초간 구동하여 건조 수행
  
  6.자동 복귀: 일정 시간(Threshold) 동안 사용자 미감지 시 LED 소등 및 IDLE 상태 전환

  <br>

5. 하드웨어 연결

   | 명칭 | 핀 번호 | 설명 |
   | --- | --- | --- |
   | US0 | 5 (Trig) /6 (Echo) | 사용자 접근 감지 |
   | US1 | 20 (Trig) / 23 (Echo) | spot1 우산 유무 감지 |
   | US2 | 21 (Trig) / 24 (Echo)| spot2 우산 유무 감지 |
   | DHT22 | 4 | 습도 측정 |
   | Cooling Fan | 17 | 릴레이를 통 12V 팬 제어 |
   | Weather RGB | R:26 / G:19 / B:13 | 강수 확률 표시 |
   | Spot LED 1,2 | spot1: 11 / spot2: 14| 사용자별 위치 표 |

<br>

6. 문제 해결 및 최적화
   
   초음파 센서 측정 불안정성:  초음파 센서의 값이 간헐적으로 튀어 우산이 없음에도 있는 것으로 인식되는 경우가 있음


   해결: 우산 유무를 감지 할 때, 현재 우산 보관 상태에 따라 임계값을 다르게 하여 확실한 상태 변화만 감지하는 히스테리시스 로직 적용

   <br>

   DHT22 센서의 데이터 읽기 실패로 인한 오류: DHT22 센서의 데이터 읽기 실패율이 높아 예외가 자주 발생
   
   해결: 습도 측정 시 최대 5회의 재시도 로직과 2초의 지연 시간을 추가하여 데이터 신뢰성 확보

   <br>

   상태 전환 안정성 문제: 루프 주기가 0.5초로 짧아서 초음파 센서가 순간적으로 사용자를 인식하지 못하면 즉시 IDLE 상태로 복귀하는 문제

   해결: 사용자의 일시적인 미감지를 허용하기 위해 카운터 기반의 임계값 로직을 적용하여 사람이 감지되지 않더라도 즉시 종료하지 않고, no_person_count가 설정된 임계치를 초과할 때만 시스템을 비활성화하도록 수정
